# White Rabbit on general purpose FPGA boards (without the dedicated external oscillators)

Based on the original contribution by <a href="https://www.missinglinkelectronics.com/wp-content/uploads/2024/03/MLE-Light-Rabbit-Presentation-at-13th-White-Rabbit-Workshop.pdf">Missing Link Electronics</a> at the 13th White Rabbit
Workshop at CERN in 2024 and with the help of Nikhef's <a href="https://www.nikhef.nl/~peterj/">Peter Jansweijer</a>
CLBv3 (found on <a href="https://gitlab.com/ohwr/project/wr-cores/-/tree/master/syn/clbv3_ref_design?ref_type=heads">the OHWR gitlab repository</a>), this project demonstrates a functional White Rabbit implementation
on the <a href="https://enjoy-digital-shop.myshopify.com/products/litex-acorn-baseboard-mini-sqrl-acorn-cle215">Acorn CLE215+</a> Artix7 FPGA.

<img src="pictures/IMG_20250425_163316_728.jpg">

## Synthesizing for the Acorn CLE215+

The patch applied to the White Rabbit PTP Core repository allowing to synthetsize the project for the Acorn
CLE215+ as well as the instructions are found in the <a href="patch/">patch</a> repository.

## PLL gain settings

From the shell connected to the embdded RISC-V processor, the main PLL gain coefficients (proportional and integral) are set using the command
```
pll gain 0 0 -400 -2 12
```

and similartly for the helper PLL (any negative number will do instead of -1 as 2nd argument)
```
pll gain -1 0 -400 -2 12
```

## Results


MDEV measurement as a function of PLL loop gain coefficients, changing Kp while
keeping Ki fixed (-2) except for two measurements, of the time interval between the 
White Rabbit Switche (WRS) and the CLE215+ 1-PPS outputs. For reference, WRS is the Modified 
Allan Deviation of the two PPS generated by two WRS (Creotech),
matching the expected value of about 60 ps jitter at 1 s integration time.

<img src="pictures/mdev.png">

Beyond the long-term time-domain characteristics, the phase noise of a 10-MHz output
locked on the White Rabbit control signal is measurement as a function of control loop
parameters. Measurements performed using a Rohde & Schwarz FSWP 
Phase Noise Analyzer with 10-correlations in the 1-Hz bin.

<img src="pictures/phase_noise_edited.png">

All Modified Allan deviation plot exhibit a $1/\tau$ slope, i.e. $1/\tau^2$ for the variance,
characteristic of flicker phase noise. The MVAR of flicker PM [1] level is $0.0855 h_1/\tau^2$: at
1 Hz, the phase noise of $-70$ dBc/Hz or $-67$ dBrad $^2$ /Hz would lead to 
$\sqrt{10^{-6.7}/(10^7)^2\cdot 0.0855}=1.4\cdot 10^{-11}$. The observed $5.5\cdot 10^{-11}$ hints at a noise
model too simple to account for all contributions.

From this analysis, we conclude that "optimal" loop coefficients are **Kp=-400 and Ki=-80**.

The command ``pll stat`` must display something like
```
softpll: mode:3 seq:ready n_ref 1 n_out 1
irqs:400961 alignment_state:0 HL1 ML1 HY=25714 MY=42355 DelCnt=0 setpoint:17364 refcnt:209789 tagcnt:5
```
where HL1 means that the helper PLL is locked and ML1 means that the main PLL is 
locked.

Phase noise (M2SDR scaled 62.5-MHz v.s White Rabbit switch 10-MHz output):

<img src="m2sdr.png">

Allan deviation:

<img src="M2SDR_vs_WRS_allan.png">

[1] E. Rubiola, *Enrico's Chart of Phase Noise and Two-Sample Variances*, https://rubiola.org/pdf-static/Enrico%27s-chart-EFTS.pdf (2025)
